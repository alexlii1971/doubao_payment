# WordPress 多站点支付插件部署文档

## 一、概述
本插件为 WordPress 多站点环境提供了集成支付功能，支持与 WooCommerce 结合，涵盖微信支付、支付宝支付等多种支付方式，同时具备分账、退款、争议处理和审计日志等特性。此部署文档旨在引导用户将该插件成功部署至 WordPress 多站点环境。

## 二、环境要求

### 服务器环境
- **操作系统**：推荐使用 Linux 系统（如 Ubuntu 18.04 及以上版本），也支持 Windows Server 2016 及以上版本。
- **Web 服务器**：可选用 Apache 2.4 及以上版本或者 Nginx 1.14 及以上版本。
- **数据库**：支持 MySQL 5.6 及以上版本或者 MariaDB 10.1 及以上版本。
- **PHP**：版本需达到 7.2 及以上。

### WordPress 环境
- **WordPress 版本**：需为 5.0 及以上版本。
- **WooCommerce 插件**：必须提前安装并激活。

## 三、插件目录结构

### 1. 测试环境的完整插件文件
```
wp - multisite - payment - plugin/
├── admin/
│   ├── css/                   # 管理后台 CSS 样式文件
│   │   ├── admin - style.css  # 管理后台整体样式
│   │   └── settings - style.css # 设置页面样式
│   ├── js/                    # 管理后台 JavaScript 文件
│   │   ├── admin - script.js  # 管理后台交互脚本
│   │   └── settings - script.js # 设置页面脚本
│   ├── partials/              # 管理后台页面模板片段
│   │   ├── payment - settings - page.php # 支付设置页面模板
│   │   └── split - rules - page.php # 分账规则页面模板
│   └── admin - menu.php       # 管理后台菜单注册文件
├── includes/
│   ├── gateway/               # 支付网关相关文件
│   │   ├── wechat - pay - gateway.php  # 微信支付网关实现
│   │   ├── alipay - gateway.php      # 支付宝支付网关实现
│   │   └── abstract - payment - gateway.php # 抽象支付网关类
│   ├── utils/                 # 工具类文件
│   │   ├── logger.php         # 日志记录工具
│   │   ├── cache - manager.php # 缓存管理工具
│   │   └── encryption - utils.php # 加密工具
│   ├── models/                # 数据模型文件
│   │   ├── audit - log.php    # 审计日志模型
│   │   ├── dispute - model.php # 争议处理模型
│   │   └── split - rollback - model.php # 分账回滚模型
│   └── wp - multisite - payment - plugin - main.php # 插件主文件
├── config/
│   ├── config.json            # 插件核心配置文件
│   └── test - config.json     # 测试环境专用配置文件
├── languages/
│   ├── en_US.mo               # 英文语言二进制文件
│   ├── en_US.po               # 英文语言模板文件
│   ├── zh_CN.mo               # 中文（简体）语言二进制文件
│   └── zh_CN.po               # 中文（简体）语言模板文件
├── cache/                     # 缓存目录
├── tests/
│   ├── unit/
│   │   ├── gateway - test.php # 支付网关单元测试
│   │   ├── model - test.php   # 数据模型单元测试
│   │   └── utils - test.php   # 工具类单元测试
│   ├── integration/
│   │   ├── payment - flow - test.php # 支付流程集成测试
│   │   └── split - process - test.php # 分账流程集成测试
│   └── phpunit.xml            # PHPUnit 配置文件
└── readme.txt                 # 插件说明文档
```

### 2. 用于生产环境的完整插件文件
```
wp - multisite - payment - plugin/
├── admin/
│   ├── css/                   # 管理后台 CSS 样式文件
│   │   ├── admin - style.css  # 管理后台整体样式
│   │   └── settings - style.css # 设置页面样式
│   ├── js/                    # 管理后台 JavaScript 文件
│   │   ├── admin - script.js  # 管理后台交互脚本
│   │   └── settings - script.js # 设置页面脚本
│   ├── partials/              # 管理后台页面模板片段
│   │   ├── payment - settings - page.php # 支付设置页面模板
│   │   └── split - rules - page.php # 分账规则页面模板
│   └── admin - menu.php       # 管理后台菜单注册文件
├── includes/
│   ├── gateway/               # 支付网关相关文件
│   │   ├── wechat - pay - gateway.php  # 微信支付网关实现
│   │   ├── alipay - gateway.php      # 支付宝支付网关实现
│   │   └── abstract - payment - gateway.php # 抽象支付网关类
│   ├── utils/                 # 工具类文件
│   │   ├── logger.php         # 日志记录工具
│   │   ├── cache - manager.php # 缓存管理工具
│   │   └── encryption - utils.php # 加密工具
│   ├── models/                # 数据模型文件
│   │   ├── audit - log.php    # 审计日志模型
│   │   ├── dispute - model.php # 争议处理模型
│   │   └── split - rollback - model.php # 分账回滚模型
│   └── wp - multisite - payment - plugin - main.php # 插件主文件
├── config/
│   └── config.json            # 插件核心配置文件
├── languages/
│   ├── en_US.mo               # 英文语言二进制文件
│   ├── en_US.po               # 英文语言模板文件
│   ├── zh_CN.mo               # 中文（简体）语言二进制文件
│   └── zh_CN.po               # 中文（简体）语言模板文件
├── cache/                     # 缓存目录
└── readme.txt                 # 插件说明文档
```
在生产环境中，通常会移除 `tests` 目录，以减少不必要的文件占用和潜在的安全风险。同时，使用 `config.json` 作为正式的配置文件，而测试环境的 `test - config.json` 不再需要。

## 四、部署步骤

### 1. 下载插件
从代码仓库或者插件市场下载 `wp - multisite - payment - plugin` 插件的压缩包。

### 2. 上传插件
- 登录 WordPress 管理后台。
- 导航至“插件” -> “添加新插件”。
- 点击“上传插件”按钮，选择之前下载的插件压缩包，然后点击“安装现在”。

### 3. 激活插件
安装完成之后，点击“激活插件”。

### 4. 配置插件

#### 4.1 基础配置
- 导航到“设置” -> “支付设置”。
- 配置微信支付和支付宝支付的相关信息，如商户 ID、证书、应用 ID 和私钥等。这些信息可在相应支付平台的商户后台获取。

#### 4.2 缓存配置
插件采用文件系统作为缓存存储方式，默认的缓存目录是插件目录下的 `cache` 文件夹。该缓存机制主要用于存储一些频繁访问且相对稳定的数据，例如支付 SDK 实例、配置信息等，目的是提高插件的响应速度并降低服务器负载。

##### 缓存目录权限设置
要保证 `cache` 目录具备读写权限，不同操作系统的设置方法有所不同：

**Linux 系统**
可以使用以下命令为 `cache` 目录赋予读写权限：
```bash
chmod -R 755 /path/to/your/plugin/wp - multisite - payment - plugin/cache
```
若需要修改目录的所有者和所属组，可使用以下命令：
```bash
chown -R www - data:www - data /path/to/your/plugin/wp - multisite - payment - plugin/cache
```
其中 `www - data` 是常见的 Web 服务器用户和组，具体可能因服务器配置而有所差异。

**Windows 系统**
- 右键点击 `cache` 文件夹，选择“属性”。
- 在“安全”选项卡中，确保当前运行 Web 服务器的用户（如 `IIS_IUSRS` 或 `Network Service`）拥有“读取”和“写入”权限。

##### 缓存文件清理
在某些情形下，可能需要手动清理缓存文件，例如缓存数据过期或者出现异常时。可以按照以下步骤进行清理：
- 进入 `cache` 目录，删除其中的所有文件。
```bash
rm -rf /path/to/your/plugin/wp - multisite - payment - plugin/cache/*
```
注意：清理缓存文件之后，插件在下次访问相关数据时会重新生成缓存。

#### 4.3 数据库配置
插件依赖 WordPress 的 `$wpdb` 进行数据库操作，无需额外配置。但需要确保数据库能够正常运行，并且具备足够的权限。

#### 4.4 `config.json` 配置
`config.json` 文件存放在插件的 `config` 目录下，主要用于存储各子站点的支付相关配置信息，为插件的正常运行提供必要的参数。

##### 作用
- **存储支付配置信息**：包含不同支付方式（如微信支付、支付宝支付）的关键配置参数，像商户 ID、应用 ID、密钥、支付网关 URL、回调地址等。这些信息是插件与支付平台进行交互的基础，插件在处理支付、退款等操作时，会依据这些配置信息和支付平台进行通信。
- **多站点配置管理**：在 WordPress 多站点环境里，不同子站点可能存在不同的支付需求。`config.json` 能够为每个子站点单独配置支付信息，通过子站点的唯一标识（例如站点 ID 或者域名）来加以区分，从而实现多站点的差异化管理。
- **配置灵活性和可扩展性**：使用 `config.json` 存储配置信息，便于动态修改配置，无需对插件代码进行修改。当支付平台的 API 地址发生变化或者需要添加新的支付方式时，只需在 `config.json` 中更新或者添加相应的配置项即可。

以下是一个简单的 `config.json` 文件示例：
```json
{
    "sites": {
        "site1.example.com": {
            "payment_methods": {
                "wechat_pay": {
                    "merchant_id": "1234567890",
                    "api_key": "abcdef1234567890",
                    "gateway_url": "https://api.mch.weixin.qq.com/pay/unifiedorder",
                    "notify_url": "https://site1.example.com/wechat_pay_notify"
                },
                "alipay": {
                    "app_id": "0987654321",
                    "private_key": "-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----",
                    "gateway_url": "https://openapi.alipay.com/gateway.do",
                    "notify_url": "https://site1.example.com/alipay_notify"
                }
            },
            "split_rules": {
                "platform_ratio": 0.1,
                "merchant_ratio": 0.9
            }
        },
        "site2.example.com": {
            "payment_methods": {
                "wechat_pay": {
                    "merchant_id": "0987654321",
                    "api_key": "0987654321abcdef",
                    "gateway_url": "https://api.mch.weixin.qq.com/pay/unifiedorder",
                    "notify_url": "https://site2.example.com/wechat_pay_notify"
                }
            },
            "split_rules": {
                "platform_ratio": 0.2,
                "merchant_ratio": 0.8
            }
        }
    }
}
```

##### 注意事项
- **安全性**
    - **敏感信息保护**：`config.json` 中包含大量敏感信息，例如商户密钥、私钥等，必须严格加以保护。要设置文件权限，避免公共访问。例如，在 Linux 系统中，可以将文件权限设置为 `600`，仅允许文件所有者进行读写操作。还可以考虑对敏感信息进行加密存储，使用对称加密算法（如 AES）对密钥进行加密，在插件使用时再进行解密。
    - **防止篡改**：使用哈希算法（如 MD5、SHA - 256）计算文件的哈希值，并且在插件启动时验证哈希值是否匹配，以此防止文件被恶意篡改。
- **格式正确性**
    - **JSON 语法规范**：`config.json` 必须严格遵循 JSON 语法规范，例如 JSON 对象的键和字符串值要使用双引号，数组元素之间要用逗号分隔等。
    - **验证机制**：在插件中添加对 `config.json` 文件的验证机制，使用 JSON 解析库（如 PHP 的 `json_decode` 函数）对文件进行解析，如果解析失败，提示用户检查文件格式。
- **版本兼容性**
    - **配置项更新**：随着插件的更新，`config.json` 中的配置项可能会发生变化。在更新插件时，要确保 `config.json` 文件的版本与插件版本相互兼容。
    - **配置迁移**：若插件升级需要添加或者修改配置项，要提供相应的配置迁移脚本或者工具，帮助用户将旧版本的 `config.json` 文件迁移到新版本。
    - **版本检查**：插件启动时，检查 `config.json` 文件的版本信息，如果发现版本不兼容，提示用户进行相应的处理。
- **备份与恢复**
    - **定期备份**：由于 `config.json` 包含重要的配置信息，需要定期对其进行备份。可以使用自动化脚本或者工具（如 cron 任务）定期将其备份到安全的位置。
    - **恢复机制**：若 `config.json` 文件丢失或者损坏，要提供恢复机制。可以使用备份文件进行恢复，或者提供默认的配置模板，让用户重新进行配置。

### 5. 数据库表创建
插件在激活时会自动创建所需的数据库表，例如审计日志表、争议处理表等。若未自动创建，可以手动执行 SQL 脚本进行创建。

### 6. 语言配置
- 插件支持多语言，语言文件存放在 `languages` 文件夹中。
- 若需要使用其他语言，可以将对应的 `.po` 和 `.mo` 文件上传到 WordPress 的语言文件夹中。

## 五、测试文件处理说明

### 开发环境下的测试文件处理

#### 4.1 测试环境搭建
在开发环境中，为保证测试的准确性和完整性，需搭建专门的测试环境，尽可能模拟生产环境的配置，涵盖服务器环境、数据库版本、WordPress 版本等。
- **安装测试依赖**：确保系统已安装 PHPUnit 测试框架，可通过 Composer 进行安装，在项目根目录下执行以下命令：
```bash
composer require --dev phpunit/phpunit
```
- **配置测试环境变量**：在测试环境中，可能需配置特定的环境变量，如测试数据库的连接信息、支付平台的测试账号等。可在项目中创建 `.env.testing` 文件，并在测试脚本中加载该文件。

#### 4.2 测试用例维护
随着插件功能的不断更新和修改，测试用例也需相应维护。
- **新增功能测试**：当插件添加新功能时，需在对应的测试文件中添加新的测试用例。例如，若新增一种分账规则，需在 `tests/unit/split_test.php` 文件中添加对该分账规则的测试。
- **修改功能测试**：对现有功能进行修改时，要确保原有的测试用例仍能通过，且可根据需要添加额外测试，验证修改后的代码是否符合预期。
- **测试用例优化**：定期对测试用例进行优化，删除不必要的测试用例，合并重复的测试逻辑，提高测试效率和可维护性。

#### 4.3 自动化测试集成
为提高开发效率和代码质量，建议将测试集成到持续集成（CI）系统中。
- **选择 CI 工具**：可选择 Jenkins、GitLab CI/CD 或 GitHub Actions 等 CI 工具。
- **配置 CI 脚本**：在项目的 `.gitlab-ci.yml` 或 `.github/workflows` 目录下创建相应的配置文件，配置测试任务。例如，使用 GitHub Actions 可创建如下配置文件：
```yaml
name: PHP Tests

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 7.4

      - name: Install dependencies
        run: composer install --dev

      - name: Run tests
        run: vendor/bin/phpunit tests
```

### 生产环境下的测试文件处理

#### 4.4 排除测试文件
将插件部署到生产环境时，通常无需部署测试文件，以减少不必要的文件占用和潜在的安全风险。
- **使用 `.gitignore` 或打包工具排除**：在项目的 `.gitignore` 文件中添加测试目录（如 `tests`），确保在打包项目时不会包含测试文件。如果使用打包工具（如 Zip 或 Tar），可以在打包命令中排除测试目录。例如，使用 `zip` 命令打包插件时，可以这样操作：
```bash
zip -r wp - multisite - payment - plugin.zip wp - multisite - payment - plugin - exclude=wp - multisite - payment - plugin/tests/*
```
- **手动删除测试文件**：在部署过程中，可以手动删除测试文件和测试相关的依赖。进入插件目录，使用以下命令删除 `tests` 目录：
```bash
rm -rf /path/to/your/plugin/wp - multisite - payment - plugin/tests
```

#### 4.5 测试验证
在部署到生产环境之前，需要在测试环境中进行全面的测试验证，确保插件在生产环境中能够正常运行。
- **功能测试**
    - **支付功能测试**
        - **微信支付测试**
            - **创建测试订单**：以普通用户身份登录网站，将商品加入购物车，进入结算页面。选择微信支付作为支付方式，点击“支付”按钮。
            - **检查支付页面跳转**：确认是否成功跳转到微信支付的授权页面，页面显示的订单信息（如订单号、金额）是否与实际订单一致。
            - **模拟支付操作**：使用微信支付测试账号或沙箱环境进行支付操作。完成支付后，检查页面是否跳转到支付成功页面。
            - **检查订单状态更新**：登录 WordPress 管理后台，查看订单列表，确认该订单状态是否更新为“已支付”。检查订单详情页面，确认支付方式是否显示为微信支付，支付时间和支付金额是否正确。
        - **支付宝支付测试**：重复微信支付测试中的创建订单步骤，选择支付宝支付作为支付方式，点击“支付”按钮。确认是否成功跳转到支付宝的支付页面，页面显示的订单信息是否与实际订单一致。使用支付宝支付测试账号或沙箱环境进行支付操作，完成支付后检查页面跳转和订单状态更新情况。
    - **分账功能测试**
        - **配置分账规则**：登录 WordPress 管理后台，导航到分账设置页面，配置分账规则，如按比例分账，设置平台和商户的分账比例。
        - **创建支付订单并完成支付**：按照支付功能测试的步骤创建一个测试订单并完成支付。
        - **检查分账操作记录**：查看审计日志，确认是否有分账操作的记录，记录中的订单号、分账规则、分账金额等信息是否正确。
        - **检查资金流向**：登录支付平台的商户后台，检查平台和商户账户的资金流水，确认分账金额是否正确分配到相应账户。
    - **退款功能测试**
        - **选择待退款订单**：登录 WordPress 管理后台，选择一个已支付的订单进行退款操作。
        - **发起退款申请**：点击订单详情页面的“退款”按钮，输入退款金额和退款原因，点击“提交”。
        - **检查退款流程**：查看审计日志，确认是否有退款操作的记录，记录中的订单号、退款金额、退款原因等信息是否正确。检查支付平台的商户后台，确认退款请求是否成功发送，退款金额是否从相应账户扣除。
        - **检查订单状态更新**：刷新订单列表页面，确认该订单状态是否更新为“已退款”。检查订单详情页面，确认退款时间和退款金额是否正确显示。
        - **检查分账回滚情况**：若该订单之前进行过分账操作，查看分账回滚表，确认分账金额是否正确回滚。登录支付平台的商户后台，检查平台和商户账户的资金流水，确认分账回滚后的资金余额是否正确。
    - **争议处理功能测试**
        - **用户提交争议**：以普通用户身份登录网站，进入订单详情页面，点击“提交争议”按钮，填写争议原因，点击“提交”。登录 WordPress 管理后台，导航到争议处理页面，确认该争议信息是否正确记录，包括订单号、争议原因、提交时间等。
        - **管理员处理争议**：以管理员身份登录 WordPress 管理后台，进入争议处理页面。查看争议列表，确认争议列表中显示的争议信息是否完整。选择一个争议，点击“解决”或“拒绝”按钮，输入处理意见，点击“提交”。查看审计日志，确认是否有争议处理操作的记录，记录中的订单号、处理结果、处理意见等信息是否正确。刷新争议处理页面，确认该争议的状态是否更新为“已解决”或“已拒绝”。
    - **审计日志功能测试**
        - **进行各种操作**：进行支付、退款、争议处理等各种操作。
        - **查看审计日志**：登录 WordPress 管理后台，导航到审计日志页面。检查审计日志中是否记录了所有操作，包括操作类型、操作人员、操作时间、操作目标等信息是否完整准确。
        - **筛选和搜索功能测试**：使用审计日志页面的筛选和搜索功能，输入不同的关键词（如操作类型、操作人员、操作时间等），检查是否能正确筛选和搜索到相关的审计记录。
- **性能测试**
    - 可以使用性能测试工具（如 Apache JMeter）对插件的性能进行测试，确保在高并发情况下插件的响应时间和吞吐量符合要求。例如，模拟多个用户同时进行支付、退款等操作，记录系统的响应时间、吞吐量、错误率等指标，分析系统在不同负载下的性能表现。根据测试结果，对插件进行优化，如调整缓存策略、优化数据库查询等，以提高系统的性能和稳定性。

## 六、常见问题及解决方法

### 1. 支付失败
- **检查支付配置**：确保微信支付和支付宝支付的配置信息正确，如商户 ID、证书、应用 ID 和私钥等。若配置信息有误，登录相应支付平台的商户后台，获取正确的信息并更新到插件的支付设置中。
- **检查网络连接**：确保服务器能够正常访问支付平台的 API。可以使用 `ping` 命令测试服务器与支付平台 API 地址的网络连通性，使用 `telnet` 命令测试端口是否开放。例如：
```bash
ping api.mch.weixin.qq.com
telnet api.mch.weixin.qq.com 443
```
- **查看支付平台报错信息**：根据支付平台返回的报错信息，排查具体问题，如签名错误、账户余额不足等。支付平台通常会在回调信息或日志中返回详细的错误代码和错误描述，根据这些信息进行相应的处理。

### 2. 分账失败
- **检查分账规则**：确保分账规则配置正确，如比例是否合理，分账账户信息是否正确。登录 WordPress 管理后台，检查分账设置页面的规则配置，如有错误及时修改。
- **检查资金余额**：确保平台和商户账户有足够的资金进行分账。登录支付平台的商户后台，查看账户余额，如有必要，进行充值操作。
- **查看支付平台分账接口文档**：根据支付平台分账接口返回的错误信息，排查分账失败的原因，如分账金额超出限制、分账账户状态异常等。参考支付平台的官方文档，对错误信息进行解读和处理。

### 3. 退款失败
- **检查订单状态**：确保订单状态为已支付，且未进行过退款操作。登录 WordPress 管理后台，查看订单详情页面的订单状态，如有异常，联系相关人员进行处理。
- **检查支付平台限制**：某些支付平台可能对退款有时间或金额限制，需检查相关规定。查阅支付平台的退款政策文档，了解具体的限制条件，根据规定进行操作。
- **查看支付平台退款接口文档**：根据支付平台退款接口返回的错误信息，排查退款失败的原因，如退款金额超出支付金额、退款时间已过等。按照文档中的提示进行相应的调整。

### 4. 插件无法激活
- **检查 PHP 版本**：确保服务器的 PHP 版本符合插件要求（7.2 及以上）。可以通过在服务器上执行以下命令查看 PHP 版本：
```bash
php -v
```
如果版本不符合要求，升级 PHP 到合适的版本。
- **检查文件权限**：确保插件文件和文件夹具有正确的读写权限。使用 `ls -l` 命令查看插件目录和文件的权限，使用 `chmod` 命令修改权限。例如：
```bash
chmod -R 755 /path/to/your/plugin/wp - multisite - payment - plugin
```
- **查看错误日志**：查看 WordPress 的错误日志，根据日志中的错误信息排查插件无法激活的原因，如代码语法错误、依赖插件未安装等。WordPress 的错误日志通常位于 `wp - content` 目录下的 `debug.log` 文件中，打开该文件查看具体的错误信息。

### 5. 缓存相关问题

#### 5.1 缓存目录权限问题
- **问题描述**：插件无法读写缓存文件，可能会导致部分功能异常，如支付 SDK 实例无法缓存、配置信息无法读取等。
- **解决方法**：按照上述缓存目录权限设置的方法，确保 `cache` 目录具有正确的读写权限。可以使用 `ls -l` 命令查看目录权限，使用 `chmod` 和 `chown` 命令进行修改。例如：
```bash
chmod -R 755 /path/to/your/plugin/wp - multisite - payment - plugin/cache
chown -R www - data:www - data /path/to/your/plugin/wp - multisite - payment - plugin/cache
```

#### 5.2 缓存数据过期或异常问题
- **问题描述**：缓存数据可能会因为各种原因过期或出现异常，导致插件使用到错误的数据，影响功能正常运行。
- **解决方法**：手动清理缓存文件，让插件重新生成缓存。可以通过删除 `cache` 目录下的所有文件来清理缓存。例如：
```bash
rm -rf /path/to/your/plugin/wp - multisite - payment - plugin/cache/*
```

### 6. `config.json` 相关问题

#### 6.1 配置文件格式错误
- **问题描述**：若 `config.json` 文件格式不符合 JSON 规范，插件在解析配置时会出错，导致支付、分账等功能无法正常使用。
- **解决方法**：使用在线 JSON 验证工具或代码中的验证逻辑检查文件格式，修正语法错误，如添加缺失的引号、逗号等。可以将 `config.json` 文件内容复制到在线 JSON 验证网站（如 [JSONLint](https://jsonlint.com/)）进行验证和修复。

#### 6.2 敏感信息泄露
- **问题描述**：`config.json` 包含商户密钥等敏感信息，若文件权限设置不当或被恶意获取，可能导致信息泄露。
- **解决方法**：确保文件权限为仅所有者可读写，对敏感信息加密存储，并定期更换密钥。在 Linux 系统中，使用 `chmod 600 /path/to/your/plugin/wp - multisite - payment - plugin/config/config.json` 命令设置文件权限。使用加密工具对敏感信息进行加密，如使用 OpenSSL 进行加密操作。

#### 6.3 版本不兼容
- **问题描述**：插件升级后 `config.json` 配置项变化，旧配置文件可能与新版本插件不兼容。
- **解决方法**：参考插件更新说明，手动更新配置文件或使用插件提供的迁移工具进行配置迁移。仔细阅读插件的更新文档，按照文档中的指引对 `config.json` 文件进行修改或使用迁移脚本进行自动化迁移。

## 七、维护与监控

### 1. 日志监控
定期查看插件的日志文件，及时发现和处理异常情况。日志文件可在 `includes/utils/logger.php` 中进行配置。重点关注支付失败、分账失败、退款失败等异常操作的日志记录，分析原因并及时处理。可以设置日志轮转策略，定期清理旧的日志文件，避免日志文件占用过多磁盘空间。

### 2. 数据库备份
定期备份数据库，以防数据丢失。可使用 WordPress 插件或数据库管理工具进行备份。建议每周进行一次全量备份，并在重要操作（如支付、退款等）后进行增量备份。将备份文件存储在安全的位置，如外部存储设备或云存储服务。

### 3. 插件更新
关注插件的更新信息，及时更新插件以获取最新功能和修复已知问题。在更新插件之前，建议先备份数据库和插件文件，以防更新过程中出现问题。可以通过 WordPress 管理后台的插件更新提示进行更新操作，或者手动下载最新版本的插件并替换旧版本。

### 4. 安全检查
定期进行安全检查，如检查服务器的安全设置、插件的漏洞情况等，确保系统安全稳定运行。可使用安全扫描工具对服务器和插件进行安全扫描，及时发现并修复安全漏洞。例如，使用 Wordfence 等安全插件对 WordPress 网站进行全面的安全扫描。

## 八、附录

### 数据库表结构
| 表名 | 描述 |
| ---- | ---- |
| `wp_wmp_audit_log` | 审计日志表，记录所有支付相关操作的审计信息，包括操作类型、操作人员、操作时间、操作目标等。 |
| `wp_wmp_dispute` | 争议处理表，记录用户提交的争议信息及处理结果，包含订单号、争议原因、提交时间、处理状态、处理意见等字段。 |
| `wp_wmp_fund_flow` | 资金流水表，记录资金的流向和操作类型，如支付、分账、退款等，包含订单号、金额、操作时间、操作类型等字段。 |
| `wp_wmp_split_rollback` | 分账回滚表，记录分账回滚的相关信息，如订单号、分账金额、回滚时间等。 |

### 配置文件说明
- `config/config.json`：存储插件的配置信息，如各子站点的支付配置、分账规则等。请根据实际情况修改配置文件中的信息，确保插件正常运行。在修改配置文件之前，建议先备份原文件，以防修改错误导致插件无法正常工作。
