# WordPress 多站点支付插件部署文档

## 一、概述
本部署文档旨在指导用户将 WordPress 多站点支付插件部署到 WordPress 多站点环境中。该插件支持与 WooCommerce 集成，提供多种支付方式，如微信支付和支付宝支付，同时具备分账、退款、争议处理和审计日志等功能。

## 二、环境要求
### 服务器环境
- **操作系统**：Linux（推荐 Ubuntu 18.04 及以上）、Windows Server 2016 及以上
- **Web 服务器**：Apache 2.4 及以上 或 Nginx 1.14 及以上
- **数据库**：MySQL 5.6 及以上 或 MariaDB 10.1 及以上
- **PHP**：7.2 及以上

### WordPress 环境
- **WordPress 版本**：5.0 及以上
- **WooCommerce 插件**：需提前安装并激活

## 三、部署步骤

### 1. 下载插件
从代码仓库或插件市场下载 `wp-multisite-payment-plugin` 插件压缩包。

### 2. 上传插件
- 登录 WordPress 管理后台。
- 导航到“插件” -> “添加新插件”。
- 点击“上传插件”按钮，选择之前下载的插件压缩包，然后点击“安装现在”。

### 3. 激活插件
安装完成后，点击“激活插件”。

### 4. 配置插件
#### 4.1 基础配置
- 导航到“设置” -> “支付设置”。
- 配置微信支付和支付宝支付的相关信息，如商户 ID、证书、应用 ID 和私钥等。这些信息可在相应支付平台的商户后台获取。

#### 4.2 缓存配置
插件使用文件系统作为缓存存储，缓存目录默认为插件目录下的 `cache` 文件夹。确保该目录具有读写权限。

#### 4.3 数据库配置
插件依赖 WordPress 的 `$wpdb` 进行数据库操作，无需额外配置。但需确保数据库正常运行且具有足够的权限。

### 5. 数据库表创建
插件会在激活时自动创建所需的数据库表，如审计日志表、争议处理表等。若未自动创建，可手动执行 SQL 脚本创建。

### 6. 语言配置
- 插件支持多语言，语言文件位于 `languages` 文件夹中。
- 若需要使用其他语言，可将对应的 `.po` 和 `.mo` 文件上传到 WordPress 的语言文件夹中。

## 四、测试文件处理说明

### 开发环境下的测试文件处理
#### 4.1 测试环境搭建
在开发环境中，为了保证测试的准确性和完整性，需要搭建专门的测试环境。该环境应尽量模拟生产环境的配置，包括服务器环境、数据库版本、WordPress 版本等。
- **安装测试依赖**：确保系统中安装了 PHPUnit 测试框架。可以通过 Composer 进行安装，在项目根目录下执行以下命令：
```bash
composer require --dev phpunit/phpunit
```
- **配置测试环境变量**：在测试环境中，可能需要配置一些特定的环境变量，如测试数据库的连接信息、支付平台的测试账号等。可以在项目中创建一个 `.env.testing` 文件，并在测试脚本中加载该文件。

#### 4.2 测试用例维护
随着插件功能的不断更新和修改，测试用例也需要相应地进行维护。
- **新增功能测试**：当插件添加新功能时，需要在对应的测试添加新文件中的测试用例。例如，如果新增了一种分账规则，需要在 `tests/unit/split_test.php` 文件中添加对该分账规则的测试。
- **修改功能测试**：当对现有功能进行修改时，要确保原有的测试用例仍然能够通过，并且可以根据需要添加额外的测试来验证修改后的代码是否符合预期。
- **测试用例优化**：定期对测试用例进行优化，删除不必要的测试用例，合并重复的测试逻辑，提高测试的效率和可维护性。

#### 4.3 自动化测试集成
为了提高开发效率和代码质量，建议将测试集成到持续集成（CI）系统中。
- **选择 CI 工具**：可以选择 Jenkins、GitLab CI/CD 或 GitHub Actions 等 CI 工具。
- **配置 CI 脚本**：在项目的 `.gitlab-ci.yml` 或 `.github/workflows` 目录下创建相应的配置文件，配置测试任务。例如，使用 GitHub Actions 可以创建如下配置文件：
```yaml
name: PHP Tests

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 7.4

      - name: Install dependencies
        run: composer install --dev

      - name: Run tests
        run: vendor/bin/phpunit tests
```

### 生产环境下的测试文件处理
#### 4.4 排除测试文件
在将插件部署到生产环境时，通常不需要将测试文件部署到服务器上，以减少不必要的文件占用和潜在的安全风险。
- **使用 `.gitignore` 或打包工具排除**：在项目的 `.gitignore` 文件中添加测试目录（如 `tests`），确保在打包项目时不会包含测试文件。如果使用打包工具（如 Zip 或 Tar），可以在打包命令中排除测试目录。
- **手动删除测试文件**：在部署过程中，可以手动删除测试文件和测试相关的依赖。

#### 4.5 测试验证
在部署到生产环境之前，需要在测试环境中进行全面的测试验证，确保插件在生产环境中能够正常运行。
- **功能测试**：按照之前提到的功能测试步骤，对支付、分账、退款、争议处理等功能进行测试。
- **性能测试**：可以使用性能测试工具（如 Apache JMeter）对插件的性能进行测试，确保在高并发情况下插件的响应时间和吞吐量符合要求。

## 五、功能测试

### 1. 支付功能测试

#### 1.1 微信支付测试
- **创建测试订单**
    - 以普通用户身份登录网站，将商品加入购物车，进入结算页面。
    - 选择微信支付作为支付方式，点击“支付”按钮。
- **检查支付页面跳转**
    - 确认是否成功跳转到微信支付的授权页面，页面显示的订单信息（如订单号、金额）是否与实际订单一致。
- **模拟支付操作**
    - 使用微信支付测试账号或沙箱环境进行支付操作。
    - 完成支付后，检查页面是否跳转到支付成功页面。
- **检查订单状态更新**
    - 登录 WordPress 管理后台，查看订单列表，确认该订单状态是否更新为“已支付”。
    - 检查订单详情页面，确认支付方式是否显示为微信支付，支付时间和支付金额是否正确。

#### 1.2 支付宝支付测试
- **创建测试订单**
    - 重复微信支付测试中的创建订单步骤，选择支付宝支付作为支付方式，点击“支付”按钮。
- **检查支付页面跳转**
    - 确认是否成功跳转到支付宝的支付页面，页面显示的订单信息（如订单号、金额）是否与实际订单一致。
- **模拟支付操作**
    - 使用支付宝支付测试账号或沙箱环境进行支付操作。
    - 完成支付后，检查页面是否跳转到支付成功页面。
- **检查订单状态更新**
    - 登录 WordPress 管理后台，查看订单列表，确认该订单状态是否更新为“已支付”。
    - 检查订单详情页面，确认支付方式是否显示为支付宝支付，支付时间和支付金额是否正确。

### 2. 分账功能测试
- **配置分账规则**
    - 登录 WordPress 管理后台，导航到分账设置页面。
    - 配置分账规则，例如按比例分账，设置平台和商户的分账比例。
- **创建支付订单并完成支付**
    - 按照支付功能测试的步骤创建一个测试订单并完成支付。
- **检查分账操作记录**
    - 查看审计日志，确认是否有分账操作的记录，记录中的订单号、分账规则、分账金额等信息是否正确。
- **检查资金流向**
    - 登录支付平台的商户后台，检查平台和商户账户的资金流水，确认分账金额是否正确分配到相应账户。

### 3. 退款功能测试
- **选择待退款订单**
    - 登录 WordPress 管理后台，选择一个已支付的订单进行退款操作。
- **发起退款申请**
    - 点击订单详情页面的“退款”按钮，输入退款金额和退款原因，点击“提交”。
- **检查退款流程**
    - 查看审计日志，确认是否有退款操作的记录，记录中的订单号、退款金额、退款原因等信息是否正确。
    - 检查支付平台的商户后台，确认退款请求是否成功发送，退款金额是否从相应账户扣除。
- **检查订单状态更新**
    - 刷新订单列表页面，确认该订单状态是否更新为“已退款”。
    - 检查订单详情页面，确认退款时间和退款金额是否正确显示。
- **检查分账回滚情况**
    - 若该订单之前进行过分账操作，查看分账回滚表，确认分账金额是否正确回滚。
    - 登录支付平台的商户后台，检查平台和商户账户的资金流水，确认分账回滚后的资金余额是否正确。

### 4. 争议处理功能测试
#### 4.1 用户提交争议
- **模拟用户操作**
    - 以普通用户身份登录网站，进入订单详情页面。
    - 点击“提交争议”按钮，填写争议原因，点击“提交”。
- **检查争议信息记录**
    - 登录 WordPress 管理后台，导航到争议处理页面，确认该争议信息是否正确记录，包括订单号、争议原因、提交时间等。

#### 4.2 管理员处理争议
- **管理员登录后台**
    - 以管理员身份登录 WordPress 管理后台，进入争议处理页面。
- **查看争议列表**
    - 确认争议列表中显示的争议信息是否完整，包括订单号、争议原因、提交时间等。
- **处理争议**
    - 选择一个争议，点击“解决”或“拒绝”按钮，输入处理意见，点击“提交”。
- **检查处理结果记录**
    - 查看审计日志，确认是否有争议处理操作的记录，记录中的订单号、处理结果、处理意见等信息是否正确。
    - 刷新争议处理页面，确认该争议的状态是否更新为“已解决”或“已拒绝”。

### 5. 审计日志功能测试
- **进行各种操作**
    - 进行支付、退款、争议处理等各种操作。
- **查看审计日志**
    - 登录 WordPress 管理后台，导航到审计日志页面。
    - 检查审计日志中是否记录了所有操作，包括操作类型、操作人员、操作时间、操作目标等信息是否完整准确。
- **筛选和搜索功能测试**
    - 使用审计日志页面的筛选和搜索功能，输入不同的关键词（如操作类型、操作人员、操作时间等），检查是否能正确筛选和搜索到相关的审计记录。

## 六、常见问题及解决方法

### 1. 支付失败
- **检查支付配置**：确保微信支付和支付宝支付的配置信息正确，如商户 ID、证书、应用 ID 和私钥等。
- **检查网络连接**：确保服务器能够正常访问支付平台的 API。
- **查看支付平台报错信息**：根据支付平台返回的报错信息，排查具体问题，如签名错误、账户余额不足等。

### 2. 分账失败
- **检查分账规则**：确保分账规则配置正确，如比例是否合理，分账账户信息是否正确。
- **检查资金余额**：确保平台和商户账户有足够的资金进行分账。
- **查看支付平台分账接口文档**：根据支付平台分账接口返回的错误信息，排查分账失败的原因，如分账金额超出限制、分账账户状态异常等。

### 3. 退款失败
- **检查订单状态**：确保订单状态为已支付，且未进行过退款操作。
- **检查支付平台限制**：某些支付平台可能对退款有时间或金额限制，需检查相关规定。
- **查看支付平台退款接口文档**：根据支付平台退款接口返回的错误信息，排查退款失败的原因，如退款金额超出支付金额、退款时间已过等。

### 4. 插件无法激活
- **检查 PHP 版本**：确保服务器的 PHP 版本符合插件要求（7.2 及以上）。
- **检查文件权限**：确保插件文件和文件夹具有正确的读写权限。
- **查看错误日志**：查看 WordPress 的错误日志，根据日志中的错误信息排查插件无法激活的原因，如代码语法错误、依赖插件未安装等。

## 七、维护与监控

### 1. 日志监控
定期查看插件的日志文件，及时发现和处理异常情况。日志文件可在 `includes/utils/logger.php` 中进行配置。重点关注支付失败、分账失败、退款失败等异常操作的日志记录，分析原因并及时处理。

### 2. 数据库备份
定期备份数据库，以防数据丢失。可使用 WordPress 插件或数据库管理工具进行备份。建议每周进行一次全量备份，并在重要操作（如支付、退款等）后进行增量备份。

### 3. 插件更新
关注插件的更新信息，及时更新插件以获取最新功能和修复已知问题。在更新插件之前，建议先备份数据库和插件文件，以防更新过程中出现问题。

### 4. 安全检查
定期进行安全检查，如检查服务器的安全设置、插件的漏洞情况等，确保系统安全稳定运行。可使用安全扫描工具对服务器和插件进行安全扫描，及时发现并修复安全漏洞。

## 八、附录
### 数据库表结构
| 表名 | 描述 |
| ---- | ---- |
| `wp_wmp_audit_log` | 审计日志表，记录所有支付相关操作的审计信息 |
| `wp_wmp_dispute` | 争议处理表，记录用户提交的争议信息及处理结果 |
| `wp_wmp_fund_flow` | 资金流水表，记录资金的流向和操作类型 |
| `wp_wmp_split_rollback` | 分账回滚表，记录分账回滚的相关信息 |

### 配置文件说明
- `config/config.json`：存储插件的配置信息，如各子站点的支付配置等。
- 请根据实际情况修改配置文件中的信息，确保插件正常运行。
